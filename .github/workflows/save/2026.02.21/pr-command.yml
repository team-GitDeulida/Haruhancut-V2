name: PR ëª…ë ¹ì–´ ì‹¤í–‰

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write
  pull-requests: write
  actions: write

jobs:
  parse-and-run:
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest

    steps:
      - name: Parse command
        shell: bash
        run: |
          BODY="$(echo "${{ github.event.comment.body }}" | xargs)"

          if [[ "$BODY" == "/í•˜ë£¨í•œì»· ë¹Œë“œí•˜ê³  í…ŒìŠ¤íŠ¸" ]]; then
            echo "run=true" >> $GITHUB_ENV
          else
            echo "run=false" >> $GITHUB_ENV
          fi

      - name: Stop if not matched
        if: env.run != 'true'
        run: exit 0

      - name: Acknowledge
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ğŸ¤– **í•˜ë£¨í•œì»· CI**
            `/í•˜ë£¨í•œì»· ë¹Œë“œí•˜ê³  í…ŒìŠ¤íŠ¸` ëª…ë ¹ì„ ì¸ì‹í–ˆìŠµë‹ˆë‹¤.
            ë¹Œë“œ & í…ŒìŠ¤íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤ â³

      - name: Trigger build-and-test workflow
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const ref = pr.head.ref;

            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: "build-and-test.yml",
              ref,
              inputs: {
                triggered_by_command: "true",
                pr_number: String(prNumber),
              },
            });
