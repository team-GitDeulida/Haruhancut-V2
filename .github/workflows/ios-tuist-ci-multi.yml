# name: í•˜ë£¨í•œì»· iOS Build & Test Multi

# on:
#   # UTC 22:00 = KST 07:00
#   schedule:
#     - cron: "0 22 * * *"

#   pull_request:
#     branches: [main, develop]

#   push:
#     branches: [main]

#   workflow_dispatch:
#     inputs:
#       triggered_by_command:
#         description: "Triggered by PR command"
#         required: false
#         default: "false"
#       pr_number:
#         description: "PR number"
#         required: false

# permissions:
#   contents: read
#   issues: write
#   pull-requests: write

# # =====================================================
# # ğŸ”µ Build Job
# # =====================================================
# jobs:
#   build:
#     name: iOS / Build
#     runs-on: macos-15

#     steps:
#       - uses: actions/checkout@v4

#       - name: Create Shared.xcconfig
#         run: |
#           mkdir -p Projects/Shared/Configs
#           cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
#           ${{ secrets.SHARED_XCCONFIG }}
#           EOF

#       - name: Select Xcode 16.4
#         run: |
#           sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
#           xcodebuild -version

#       - name: Cache Tuist & SwiftPM
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.tuist/Dependencies
#             ~/.tuist/Cache
#             ~/.swiftpm
#             Tuist/Dependencies/.build
#           key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift', '**/Package.resolved') }}
#           restore-keys: tuist-${{ runner.os }}-

#       - name: Install Tuist
#         run: |
#           brew tap tuist/tuist
#           brew install tuist@4.115.0

#       - name: Tuist Generate
#         run: |
#           tuist install
#           tuist generate --no-open

#       - name: Resolve Build Simulator
#         run: |
#           SIM_NAME="iPhone 16"
#           SIM_OS="18.5"
#           UDID=$(xcrun simctl list devices available | \
#             grep "iOS ${SIM_OS}" -A 20 | \
#             grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
#           [ -z "$UDID" ] && exit 1
#           echo "SIM_UDID=$UDID" >> $GITHUB_ENV

#       - name: Boot Build Simulator
#         run: xcrun simctl bootstatus "$SIM_UDID" -b

#       - name: Disable Swift Macro fingerprint validation
#         run: defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

#       - name: Build (Debug)
#         run: |
#           set -o pipefail
#           xcodebuild build \
#             -workspace Haruhancut.xcworkspace \
#             -scheme App \
#             -configuration Debug \
#             -destination "id=$SIM_UDID" \
#             | xcpretty

#   # =====================================================
#   # ğŸŸ¢ Core Test Job
#   # =====================================================
#   core-test:
#     name: iOS / Core Tests
#     runs-on: macos-15

#     steps:
#       - uses: actions/checkout@v4

#       - name: Create Shared.xcconfig
#         run: |
#           mkdir -p Projects/Shared/Configs
#           cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
#           ${{ secrets.SHARED_XCCONFIG }}
#           EOF

#       - name: Select Xcode 16.4
#         run: |
#           sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
#           xcodebuild -version

#       - name: Cache Tuist & SwiftPM
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.tuist/Dependencies
#             ~/.tuist/Cache
#             ~/.swiftpm
#             Tuist/Dependencies/.build
#           key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift', '**/Package.resolved') }}
#           restore-keys: tuist-${{ runner.os }}-

#       - name: Install Tuist
#         run: |
#           brew tap tuist/tuist
#           brew install tuist@4.115.0

#       - name: Tuist Generate
#         run: |
#           tuist install
#           tuist generate --no-open

#       - name: Resolve Core Test Simulator
#         run: |
#           SIM_NAME="iPhone 16"
#           SIM_OS="18.5"
#           UDID=$(xcrun simctl list devices available | \
#             grep "iOS ${SIM_OS}" -A 20 | \
#             grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
#           [ -z "$UDID" ] && exit 1
#           echo "SIM_UDID=$UDID" >> $GITHUB_ENV

#       - name: Boot Core Test Simulator
#         run: xcrun simctl bootstatus "$SIM_UDID" -b

#       - name: Tuist Test Core
#         run: |
#           set -o pipefail
#           tuist test Core \
#             --configuration Debug \
#             --skip-ui-tests

#   # =====================================================
#   # ğŸŸ¡ Data Test Job
#   # =====================================================
#   data-test:
#     name: iOS / Data Tests
#     runs-on: macos-15

#     steps:
#       - uses: actions/checkout@v4

#       - name: Create Shared.xcconfig
#         run: |
#           mkdir -p Projects/Shared/Configs
#           cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
#           ${{ secrets.SHARED_XCCONFIG }}
#           EOF

#       - name: Select Xcode 16.4
#         run: |
#           sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
#           xcodebuild -version

#       - name: Cache Tuist & SwiftPM
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.tuist/Dependencies
#             ~/.tuist/Cache
#             ~/.swiftpm
#             Tuist/Dependencies/.build
#           key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift', '**/Package.resolved') }}
#           restore-keys: tuist-${{ runner.os }}-

#       - name: Install Tuist
#         run: |
#           brew tap tuist/tuist
#           brew install tuist@4.115.0

#       - name: Tuist Generate
#         run: |
#           tuist install
#           tuist generate --no-open

#       - name: Resolve Data Test Simulator
#         run: |
#           SIM_NAME="iPhone 16"
#           SIM_OS="18.5"
#           UDID=$(xcrun simctl list devices available | \
#             grep "iOS ${SIM_OS}" -A 20 | \
#             grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
#           [ -z "$UDID" ] && exit 1
#           echo "SIM_UDID=$UDID" >> $GITHUB_ENV

#       - name: Boot Data Test Simulator
#         run: xcrun simctl bootstatus "$SIM_UDID" -b

#       - name: Tuist Test Data
#         run: |
#           set -o pipefail
#           tuist test Data \
#             --configuration Debug \
#             --skip-ui-tests

#   # =====================================================
#   # ğŸŸ£ App Integration Test Job
#   # =====================================================
#   app-test:
#     name: iOS / App Tests
#     runs-on: macos-15

#     steps:
#       - uses: actions/checkout@v4

#       - name: Create Shared.xcconfig
#         run: |
#           mkdir -p Projects/Shared/Configs
#           cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
#           ${{ secrets.SHARED_XCCONFIG }}
#           EOF

#       - name: Select Xcode 16.4
#         run: |
#           sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
#           xcodebuild -version

#       - name: Cache Tuist & SwiftPM
#         uses: actions/cache@v4
#         with:
#           path: |
#             ~/.tuist/Dependencies
#             ~/.tuist/Cache
#             ~/.swiftpm
#             Tuist/Dependencies/.build
#           key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift', '**/Package.resolved') }}
#           restore-keys: tuist-${{ runner.os }}-

#       - name: Install Tuist
#         run: |
#           brew tap tuist/tuist
#           brew install tuist@4.115.0

#       - name: Tuist Generate
#         run: |
#           tuist install
#           tuist generate --no-open

#       - name: Resolve App Test Simulator
#         run: |
#           SIM_NAME="iPhone 16"
#           SIM_OS="18.5"
#           UDID=$(xcrun simctl list devices available | \
#             grep "iOS ${SIM_OS}" -A 20 | \
#             grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
#           [ -z "$UDID" ] && exit 1
#           echo "SIM_UDID=$UDID" >> $GITHUB_ENV

#       - name: Boot App Test Simulator
#         run: xcrun simctl bootstatus "$SIM_UDID" -b

#       - name: Tuist Test App (Integration)
#         run: |
#           set -o pipefail
#           tuist test App \
#             --configuration Debug \
#             --skip-ui-tests

#   # =====================================================
#   # ğŸ“£ Notify Job
#   # =====================================================
#   notify:
#     name: Notify Result
#     runs-on: macos-15
#     needs: [build, core-test, data-test, app-test]
#     if: always()

#     steps:
#       # âœ… ì„±ê³µ PR ì½”ë©˜íŠ¸
#       - name: Comment success
#         if: needs.build.result == 'success' &&
#           needs.core-test.result == 'success' &&
#           needs.data-test.result == 'success' &&
#           needs.app-test.result == 'success' &&
#           github.event.inputs.triggered_by_command == 'true' &&
#           github.event.inputs.pr_number != ''
#         uses: peter-evans/create-or-update-comment@v4
#         with:
#           issue-number: ${{ github.event.inputs.pr_number }}
#           body: |
#             âœ… **í•˜ë£¨í•œì»· iOS CI ì„±ê³µ**
#             - Build: âœ…
#             - Core Tests: âœ…
#             - Data Tests: âœ…
#             - App Integration Tests: âœ…

#       # âŒ ì‹¤íŒ¨ PR ì½”ë©˜íŠ¸
#       - name: Comment failure
#         if: (needs.build.result != 'success' ||
#           needs.core-test.result != 'success' ||
#           needs.data-test.result != 'success' ||
#           needs.app-test.result != 'success') &&
#           github.event.inputs.triggered_by_command == 'true' &&
#           github.event.inputs.pr_number != ''
#         uses: peter-evans/create-or-update-comment@v4
#         with:
#           issue-number: ${{ github.event.inputs.pr_number }}
#           body: |
#             âŒ **í•˜ë£¨í•œì»· iOS CI ì‹¤íŒ¨**
#             - Build: ${{ needs.build.result }}
#             - Core Tests: ${{ needs.core-test.result }}
#             - Data Tests: ${{ needs.data-test.result }}
#             - App Integration Tests: ${{ needs.app-test.result }}

#       # âœ… ì„±ê³µ ë©”ì¼
#       - name: Send email on success
#         if: needs.build.result == 'success' &&
#           needs.core-test.result == 'success' &&
#           needs.data-test.result == 'success' &&
#           needs.app-test.result == 'success'
#         uses: dawidd6/action-send-mail@v3
#         with:
#           server_address: smtp.gmail.com
#           server_port: 465
#           username: ${{ secrets.MAIL_USERNAME }}
#           password: ${{ secrets.MAIL_PASSWORD }}
#           subject: âœ… í•˜ë£¨í•œì»· iOS CI ì„±ê³µ
#           body: |
#             âœ… Build / Core Tests / App Integration Tests ëª¨ë‘ ì„±ê³µí–ˆìŠµë‹ˆë‹¤.

#             Repository: ${{ github.repository }}
#             Branch: ${{ github.ref_name }}
#             Actor: ${{ github.actor }}
#             URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
#           to: indextrown@gmail.com
#           from: GitHub CI <${{ secrets.MAIL_USERNAME }}>

#       # âŒ ì‹¤íŒ¨ ë©”ì¼
#       - name: Send email on failure
#         if: needs.build.result != 'success' ||
#           needs.core-test.result != 'success' ||
#           needs.data-test.result != 'success' ||
#           needs.app-test.result != 'success'
#         uses: dawidd6/action-send-mail@v3
#         with:
#           server_address: smtp.gmail.com
#           server_port: 465
#           username: ${{ secrets.MAIL_USERNAME }}
#           password: ${{ secrets.MAIL_PASSWORD }}
#           subject: âŒ í•˜ë£¨í•œì»· iOS CI ì‹¤íŒ¨
#           body: |
#             âŒ CI ì‹¤íŒ¨ ë°œìƒ

#             Build: ${{ needs.build.result }}
#             Core Tests: ${{ needs.core-test.result }}
#             Data Tests: ${{ needs.data-test.result }}
#             App Integration Tests: ${{ needs.app-test.result }}

#             URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
#           to: indextrown@gmail.com
#           from: GitHub CI <${{ secrets.MAIL_USERNAME }}>

name: í•˜ë£¨í•œì»· iOS CI

on:
  schedule:
    - cron: "0 22 * * *"

  pull_request:
    branches: [main, develop]

  push:
    branches: [main]

  workflow_dispatch:
    inputs:
      triggered_by_command:
        description: "Triggered by PR command"
        required: false
        default: "false"
      pr_number:
        description: "PR number"
        required: false

permissions:
  contents: read
  issues: write
  pull-requests: write

# =====================================================
# 1. Build For Testing
# =====================================================
jobs:
  build:
    name: Build For Testing
    runs-on: macos-15

    steps:
      - uses: actions/checkout@v4

      - name: Create Shared.xcconfig
        run: |
          mkdir -p Projects/Shared/Configs
          cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
          ${{ secrets.SHARED_XCCONFIG }}
          EOF

      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      # key: spm-${{ runner.os }}-xcode16.4-${{ hashFiles('**/Package.resolved') }}
      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Cache Tuist
        uses: actions/cache@v4
        with:
          path: |
            ~/.tuist/Dependencies
            ~/.tuist/Cache
            Tuist/Dependencies/.build
          key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift') }}
          restore-keys: |
            tuist-${{ runner.os }}-

      - name: Install Tuist
        run: |
          brew tap tuist/tuist
          brew install tuist@4.115.0

      - name: Generate
        run: |
          tuist install
          tuist generate --no-open

      # âœ… UUID Resolve
      - name: Resolve Simulator UUID
        run: |
          SIM_NAME="iPhone 16"
          SIM_OS="18.5"
          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIM_OS}" -A 20 | \
            grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          [ -z "$UDID" ] && echo "Simulator not found" && exit 1
          echo "SIM_UDID=$UDID" >> $GITHUB_ENV

      - name: Boot Simulator
        run: xcrun simctl bootstatus "$SIM_UDID" -b

      - name: Build For Testing
        run: |
          xcodebuild build-for-testing \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -configuration Debug \
            -destination "id=$SIM_UDID" \
            -derivedDataPath DerivedData

      - name: Upload DerivedData
        uses: actions/upload-artifact@v4
        with:
          name: derived-data
          path: DerivedData

  # =====================================================
  # 2ï¸. Matrix Test
  # =====================================================
  test:
    name: Test / ${{ matrix.module }}
    runs-on: macos-15
    needs: build

    strategy:
      fail-fast: false
      matrix:
        module: [Core, Data, App]

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Download DerivedData
        uses: actions/download-artifact@v4
        with:
          name: derived-data
          path: DerivedData

      - name: Install Tuist
        run: |
          brew tap tuist/tuist
          brew install tuist@4.115.0

      - name: Generate
        run: |
          tuist install
          tuist generate --no-open

      # âœ… ë™ì¼ UUID resolve
      - name: Resolve Simulator UUID
        run: |
          SIM_NAME="iPhone 16"
          SIM_OS="18.5"
          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIM_OS}" -A 20 | \
            grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          [ -z "$UDID" ] && echo "Simulator not found" && exit 1
          echo "SIM_UDID=$UDID" >> $GITHUB_ENV

      - name: Boot Simulator
        run: xcrun simctl bootstatus "$SIM_UDID" -b

      - name: Run Tests
        run: |
          xcodebuild test-without-building \
            -workspace Haruhancut.xcworkspace \
            -scheme ${{ matrix.module }} \
            -configuration Debug \
            -destination "id=$SIM_UDID" \
            -derivedDataPath DerivedData

  # =====================================================
  # 3. Notify
  # =====================================================
  notify:
    name: Notify Result
    runs-on: macos-15
    needs: test
    if: always()

    steps:
      # PRì¼ ë•Œë§Œ ì½”ë©˜íŠ¸
      - name: Comment success (PR only)
        if: needs.test.result == 'success' && github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… **í•˜ë£¨í•œì»· iOS CI ì„±ê³µ**
            - Core / Data / App í…ŒìŠ¤íŠ¸ ëª¨ë‘ ì„±ê³µ ğŸ‰

      - name: Comment failure (PR only)
        if: needs.test.result != 'success' && github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âŒ **í•˜ë£¨í•œì»· iOS CI ì‹¤íŒ¨**
            - ì¼ë¶€ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨

      # ë©”ì¼ì€ ëª¨ë“  ì´ë²¤íŠ¸ì—ì„œ
      - name: Send email on success
        if: needs.test.result == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: âœ… í•˜ë£¨í•œì»· iOS CI ì„±ê³µ
          body: |
            CI ì„±ê³µ ğŸ‰

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Actor: ${{ github.actor }}
            URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: indextrown@gmail.com
          from: GitHub CI <${{ secrets.MAIL_USERNAME }}>

      - name: Send email on failure
        if: needs.test.result != 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: âŒ í•˜ë£¨í•œì»· iOS CI ì‹¤íŒ¨
          body: |
            CI ì‹¤íŒ¨ ë°œìƒ âŒ

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Actor: ${{ github.actor }}
            URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: indextrown@gmail.com
          from: GitHub CI <${{ secrets.MAIL_USERNAME }}>
