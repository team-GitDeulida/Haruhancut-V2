# build-and-test.yml
name: í•˜ë£¨í•œì»· Build & Test

on:
  workflow_dispatch:
    inputs:
      triggered_by_command:
        description: "Triggered by PR command"
        required: false
        default: "false"
      pr_number:
        description: "PR number"
        required: false

  schedule:
    # UTC 22:00 = KST 07:00
    - cron: "0 22 * * *"

  # PR ëŒ“ê¸€ ëª…ë ¹ì–´ë¡œë„ íŠ¸ë¦¬ê±° ê°€ëŠ¥
  # issue_comment:
  #   types: [created]

  # PRì´ ì—´ë¦´ ë•Œë§ˆë‹¤ ì‹¤í–‰ (main, develop ë¸Œëœì¹˜ ëŒ€ìƒ)
  pull_request:
    branches: [main]

  # main ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œë§ˆë‹¤ ì‹¤í–‰ (PR ë³‘í•© í¬í•¨)
  # push:
  #   branches: [main]

permissions:
  contents: read
  issues: write
  pull-requests: write

# =====================================================
# 1. Build For Testing
# =====================================================
jobs:
  build:
    name: Build For Testing
    runs-on: macos-15

    # pr -> build skip
    # if: |
    #   github.event_name != 'pull_request' ||
    #   inputs.triggered_by_command == 'true'

    steps:
      - uses: actions/checkout@v4

      - name: Create Shared.xcconfig
        run: |
          mkdir -p Projects/Shared/Configs
          cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
          ${{ secrets.SHARED_XCCONFIG }}
          EOF

      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      # key: spm-${{ runner.os }}-xcode16.4-${{ hashFiles('**/Package.resolved') }}
      - name: Cache SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
          key: spm-${{ runner.os }}-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            spm-${{ runner.os }}-

      - name: Cache Tuist
        uses: actions/cache@v4
        with:
          path: |
            ~/.tuist/Dependencies
            ~/.tuist/Cache
            Tuist/Dependencies/.build
          key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift') }}
          restore-keys: |
            tuist-${{ runner.os }}-

      - name: Install Tuist
        run: |
          brew tap tuist/tuist
          brew install tuist@4.115.0

      - name: Generate
        run: |
          tuist install
          tuist generate --no-open

      # âœ… UUID Resolve
      - name: Resolve Simulator UUID
        run: |
          SIM_NAME="iPhone 16"
          SIM_OS="18.5"
          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIM_OS}" -A 20 | \
            grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          [ -z "$UDID" ] && echo "Simulator not found" && exit 1
          echo "SIM_UDID=$UDID" >> $GITHUB_ENV

      - name: Build For Testing (App only)
        run: |
          xcodebuild build-for-testing \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -configuration Debug \
            -destination "id=$SIM_UDID" \
            -derivedDataPath DerivedData \
            -parallelizeTargets \
            -jobs $(sysctl -n hw.ncpu)

      - name: Upload DerivedData
        uses: actions/upload-artifact@v4
        with:
          name: derived-data
          path: DerivedData/Build/Products

      - name: Upload Workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace
          path: |
            Haruhancut.xcworkspace
            **/*.xcodeproj

  # =====================================================
  # 2ï¸. Matrix Test
  # =====================================================
  test:
    name: Test / ${{ matrix.module }}
    runs-on: macos-15
    needs: build

    strategy:
      fail-fast: false
      matrix:
        module: [Core, Data, App]

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode 16.4
        run: sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer

      - name: Create Shared.xcconfig
        run: |
          mkdir -p Projects/Shared/Configs
          cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
          ${{ secrets.SHARED_XCCONFIG }}
          EOF

      - name: Download DerivedData
        uses: actions/download-artifact@v4
        with:
          name: derived-data
          path: DerivedData/Build/Products

      - name: Download Workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace

      # âœ… ë™ì¼ UUID resolve
      - name: Resolve Simulator UUID
        run: |
          SIM_NAME="iPhone 16"
          SIM_OS="18.5"
          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIM_OS}" -A 20 | \
            grep "^ *${SIM_NAME} (" | head -n 1 | sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')
          [ -z "$UDID" ] && echo "Simulator not found" && exit 1
          echo "SIM_UDID=$UDID" >> $GITHUB_ENV

      - name: Run Tests
        run: |
          xcodebuild test-without-building \
            -workspace Haruhancut.xcworkspace \
            -scheme ${{ matrix.module }} \
            -configuration Debug \
            -destination "id=$SIM_UDID" \
            -derivedDataPath DerivedData

  # =====================================================
  # 3. Notify
  # =====================================================
  notify:
    name: Notify Result
    runs-on: macos-15
    needs: test
    if: always()

    steps:
      # PRì¼ ë•Œë§Œ ì½”ë©˜íŠ¸
      - name: Comment success (PR only)
        # PRì´ ì„±ê³µì´ê³ , ì´ë²¤íŠ¸ê°€ PRì¼ ë•Œë§Œ ì½”ë©˜íŠ¸
        if: needs.test.result == 'success' && github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âœ… í•˜ë£¨í•œì»· íŒ¨í‚¤ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œí•˜ê³  í…ŒìŠ¤íŠ¸í–ˆìŠµë‹ˆë‹¤.
      # PRì´ ì‹¤íŒ¨ì´ê³ , ì´ë²¤íŠ¸ê°€ PRì¼ ë•Œë§Œ ì½”ë©˜íŠ¸
      - name: Comment failure (PR only)
        if: needs.test.result != 'success' && github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            âŒ **í•˜ë£¨í•œì»· iOS CI ì‹¤íŒ¨**
            - ì¼ë¶€ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨

      # ë©”ì¼ì€ ëª¨ë“  ì´ë²¤íŠ¸ì—ì„œ
      - name: Send email on success
        if: needs.test.result == 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: âœ… í•˜ë£¨í•œì»· iOS CI ì„±ê³µ
          body: |
            CI ì„±ê³µ ğŸ‰

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Actor: ${{ github.actor }}
            URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: indextrown@gmail.com
          from: GitHub CI <${{ secrets.MAIL_USERNAME }}>

      - name: Send email on failure
        if: needs.test.result != 'success'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: âŒ í•˜ë£¨í•œì»· iOS CI ì‹¤íŒ¨
          body: |
            CI ì‹¤íŒ¨ ë°œìƒ âŒ

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Actor: ${{ github.actor }}
            URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: indextrown@gmail.com
          from: GitHub CI <${{ secrets.MAIL_USERNAME }}>
