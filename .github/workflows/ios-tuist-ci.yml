name: ÌïòÎ£®ÌïúÏª∑ iOS Build & Test

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  ios-ci:
    name: iOS Tuist Build & Test
    runs-on: macos-15

    steps:
      # =====================================================
      # 1Ô∏è‚É£ Checkout
      # =====================================================
      - name: Checkout
        uses: actions/checkout@v4

      # =====================================================
      # 2Ô∏è‚É£ Xcode Í≥†Ï†ï
      # =====================================================
      - name: Select Xcode 16.2
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app
          xcodebuild -version

      # =====================================================
      # 3Ô∏è‚É£ Simulator Î™©Î°ù Ï∂úÎ†• (ÎîîÎ≤ÑÍπÖÏö©)
      # =====================================================
      - name: List available iOS simulators
        run: |
          echo "üì± Available iOS Simulators"
          xcrun simctl list devices available

      # =====================================================
      # 4Ô∏è‚É£ Tuist Ï∫êÏãú
      # =====================================================
      - name: Cache Tuist & SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/.tuist
            ~/.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift', '**/Package.resolved') }}
          restore-keys: |
            tuist-${{ runner.os }}-

      # =====================================================
      # 5Ô∏è‚É£ Tuist Install & Generate
      # =====================================================
      - name: Install Tuist
        run: |
          brew tap tuist/tuist
          brew install tuist@4.115.0
          tuist version

      - name: Tuist Generate
        run: |
          tuist install
          tuist generate --no-open

      # =====================================================
      # 6Ô∏è‚É£ Simulator UDID Resolve (PopPang Î∞©Ïãù)
      # =====================================================
      - name: Resolve simulator UDID
        run: |
          set -euo pipefail

          SIMULATOR_NAME="iPhone 16 Pro"
          SIMULATOR_OS="18.2"

          echo "üîç Resolving simulator: ${SIMULATOR_NAME} (iOS ${SIMULATOR_OS})"

          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIMULATOR_OS}" -A 20 | \
            grep "^ *${SIMULATOR_NAME} (" | \
            head -n 1 | \
            sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$UDID" ]; then
            echo "‚ùå Simulator not found"
            xcrun simctl list devices available
            exit 1
          fi

          echo "‚úÖ Using simulator UDID: $UDID"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

      # =====================================================
      # 7Ô∏è‚É£ Simulator Boot & Warm-up
      # =====================================================
      - name: Boot simulator
        run: |
          xcrun simctl bootstatus "$SIMULATOR_UDID" -b

      - name: Warm up simulator
        run: |
          xcodebuild \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -destination "id=$SIMULATOR_UDID" \
            -showdestinations \
            > /dev/null

      # =====================================================
      # 8Ô∏è‚É£ Swift Macro fingerprint validation ÎπÑÌôúÏÑ±Ìôî
      # =====================================================
      - name: Disable Swift Macro fingerprint validation
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      # =====================================================
      # 9Ô∏è‚É£ Build for Testing
      # =====================================================
      - name: Build for testing
        run: |
          set -o pipefail
          xcodebuild build-for-testing \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -configuration Debug \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData

      # =====================================================
      # üîü Unit Tests
      # =====================================================
      - name: Run Unit Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            -only-testing:HaruhancutTests

      # =====================================================
      # 1Ô∏è‚É£1Ô∏è‚É£ UI Tests
      # =====================================================
      - name: Run UI Tests
        run: |
          set -o pipefail
          xcodebuild test-without-building \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData \
            -only-testing:HaruhancutUITests
