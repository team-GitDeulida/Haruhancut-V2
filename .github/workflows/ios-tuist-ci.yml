name: í•˜ë£¨í•œì»· iOS Build & Test

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  ios-ci:
    name: iOS Tuist Build & Test
    runs-on: macos-15

    steps:
      # =====================================================
      # 1ï¸âƒ£ Checkout
      # =====================================================
      - name: Checkout
        uses: actions/checkout@v4

      # =====================================================
      # âœ… 1.5ï¸âƒ£ secrets â†’ Shared.xcconfig (Tuist ì „ì— ë°˜ë“œì‹œ!)
      # =====================================================
      - name: Create Shared.xcconfig
        run: |
          mkdir -p Projects/Shared/Configs
          cat << 'EOF' > Projects/Shared/Configs/Shared.xcconfig
          ${{ secrets.SHARED_XCCONFIG }}
          EOF

      - name: List installed Xcode versions
        run: |
          ls /Applications | grep Xcode

      # =====================================================
      # 2ï¸âƒ£ Xcode ê³ ì •
      # =====================================================
      - name: Select Xcode 16.4
        run: |
          sudo xcode-select -s /Applications/Xcode_16.4.app/Contents/Developer
          xcodebuild -version

      # =====================================================
      # 3ï¸âƒ£ Simulator ëª©ë¡ ì¶œë ¥ (ë””ë²„ê¹…ìš©)
      # =====================================================
      - name: List available iOS simulators
        run: |
          echo "ğŸ“± Available iOS Simulators"
          xcrun simctl list devices available

      # =====================================================
      # 4ï¸âƒ£ Tuist ìºì‹œ
      # =====================================================
      - name: Cache Tuist & SwiftPM
        uses: actions/cache@v4
        with:
          path: |
            ~/.tuist
            ~/.swiftpm
            ~/Library/Developer/Xcode/DerivedData
          key: tuist-${{ runner.os }}-${{ hashFiles('Tuist/Dependencies.swift', '**/Package.resolved') }}
          restore-keys: |
            tuist-${{ runner.os }}-

      # =====================================================
      # 5ï¸âƒ£ Tuist Install & Generate
      # =====================================================
      - name: Install Tuist
        run: |
          brew tap tuist/tuist
          brew install tuist@4.115.0
          tuist version

      - name: Tuist Generate
        run: |
          tuist install
          tuist generate --no-open

      # =====================================================
      # 6ï¸âƒ£ Simulator UDID Resolve (PopPang ë°©ì‹)
      # =====================================================
      - name: Resolve simulator UDID
        run: |
          set -euo pipefail

          SIMULATOR_NAME="iPhone 16"
          SIMULATOR_OS="18.5"

          echo "ğŸ” Resolving simulator: ${SIMULATOR_NAME} (iOS ${SIMULATOR_OS})"

          UDID=$(xcrun simctl list devices available | \
            grep "iOS ${SIMULATOR_OS}" -A 20 | \
            grep "^ *${SIMULATOR_NAME} (" | \
            head -n 1 | \
            sed -E 's/.*\(([A-F0-9-]+)\).*/\1/')

          if [ -z "$UDID" ]; then
            echo "âŒ Simulator not found"
            xcrun simctl list devices available
            exit 1
          fi

          echo "âœ… Using simulator UDID: $UDID"
          echo "SIMULATOR_UDID=$UDID" >> $GITHUB_ENV

      # =====================================================
      # 7ï¸âƒ£ Simulator Boot & Warm-up
      # =====================================================
      - name: Boot simulator
        run: |
          xcrun simctl bootstatus "$SIMULATOR_UDID" -b

      - name: Warm up simulator
        run: |
          xcodebuild \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -destination "id=$SIMULATOR_UDID" \
            -showdestinations \
            > /dev/null

      # =====================================================
      # 8ï¸âƒ£ Swift Macro fingerprint validation ë¹„í™œì„±í™”
      # =====================================================
      - name: Disable Swift Macro fingerprint validation
        run: |
          defaults write com.apple.dt.Xcode IDESkipMacroFingerprintValidation -bool YES

      # =====================================================
      # 9ï¸âƒ£ Build only (í…ŒìŠ¤íŠ¸ ì—†ìŒ)
      # =====================================================
      # -destination "platform=iOS Simulator,id=$SIMULATOR_UDID" \
      - name: Build (Debug)
        run: |
          set -o pipefail
          xcodebuild build \
            -workspace Haruhancut.xcworkspace \
            -scheme App \
            -configuration Debug \
            -sdk iphonesimulator \
            -destination "id=$SIMULATOR_UDID" \
            -derivedDataPath DerivedData

      # ğŸ“§ Email ì•Œë¦¼
      - name: Send email on success
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: âœ… PopPang iOS ë¹Œë“œ & í…ŒìŠ¤íŠ¸ ì„±ê³µ
          body: |
            âœ… **í•˜ë£¨í•œì»· íŒ¨í‚¤ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¹Œë“œí•˜ê³  í…ŒìŠ¤íŠ¸í–ˆìŠµë‹ˆë‹¤.**

            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Triggered by: ${{ github.actor }}
            ğŸ”— Action URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: indextrown@gmail.com
          from: GitHub CI <${{ secrets.MAIL_USERNAME }}>

      - name: Send email on failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.MAIL_USERNAME }}
          password: ${{ secrets.MAIL_PASSWORD }}
          subject: âŒ PopPang iOS ë¹Œë“œ ì‹¤íŒ¨
          body: |
            âŒ **iOS ë¹Œë“œ ë˜ëŠ” í…ŒìŠ¤íŠ¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.**

            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸŒ¿ Branch: ${{ github.ref_name }}
            ğŸ‘¤ Triggered by: ${{ github.actor }}
            ğŸ”— Logs: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
          to: indextrown@gmail.com
          from: GitHub CI <${{ secrets.MAIL_USERNAME }}>

      # # =====================================================
      # # 9ï¸âƒ£ Build for Testing
      # # =====================================================
      # - name: Build for testing
      #   run: |
      #     set -o pipefail
      #     xcodebuild build-for-testing \
      #       -workspace Haruhancut.xcworkspace \
      #       -scheme App \
      #       -configuration Debug \
      #       -destination "id=$SIMULATOR_UDID" \
      #       -derivedDataPath DerivedData

      # # =====================================================
      # # ğŸ”Ÿ Unit Tests
      # # =====================================================
      # - name: Run Unit Tests
      #   run: |
      #     set -o pipefail
      #     xcodebuild test-without-building \
      #       -workspace Haruhancut.xcworkspace \
      #       -scheme App \
      #       -destination "id=$SIMULATOR_UDID" \
      #       -derivedDataPath DerivedData \
      #       -only-testing:HaruhancutTests

      # # =====================================================
      # # 1ï¸âƒ£1ï¸âƒ£ UI Tests
      # # =====================================================
      # - name: Run UI Tests
      #   run: |
      #     set -o pipefail
      #     xcodebuild test-without-building \
      #       -workspace Haruhancut.xcworkspace \
      #       -scheme App \
      #       -destination "id=$SIMULATOR_UDID" \
      #       -derivedDataPath DerivedData \
      #       -only-testing:HaruhancutUITests
